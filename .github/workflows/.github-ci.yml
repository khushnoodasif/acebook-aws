name: ci-cd
on: [push]
jobs:
  app-setup:
    runs-on: ubuntu-latest
   
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v2
      
      - name: Install dependencies
        run: npm install

      - name: use cache 
        uses: actions/cache@v2
        with:
          path: "./*"
          key: ${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}          

  deploy:
    needs: [app-setup]
    runs-on: ubuntu-latest

    steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v1
          with:
            role-to-assume: arn:aws:iam::134491901103:role/GitHubActionsRole
            aws-region: eu-west-2
    script:
      # Creates a ZIP file containing all the files (except hidden files) in the current directory and uploads it to S3 in the format CodeDeploy expects.
      - > 
          aws deploy push
          --application-name kush-app
          --ignore-hidden-files
          --s3-location s3://kush-bucket/acebook.zip
          --source .
      # Tells CodeDeploy to deploy the application that was just uploaded to S3.
      - >
          aws deploy create-deployment
          --application-name kush-app
          --s3-location bucket=kush-bucket,key=acebook.zip,bundleType=zip
          --deployment-group-name kush-group
          --file-exists-behavior OVERWRITE